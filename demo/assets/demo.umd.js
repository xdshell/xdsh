var e,t,i;(e=self.document)&&!e.getElementById("livereloadscript")&&((t=e.createElement("script")).async=1,t.src="//"+(self.location.host||"localhost").split(":")[0]+":35729/livereload.js?snipver=1",t.id="livereloadscript",e.getElementsByTagName("head")[0].appendChild(t)),function(e){e[e.dir=0]="dir",e[e.text=1]="text",e[e.link=2]="link",e[e.exe=3]="exe"}(i||(i={}));class s{image;path;exePath;constructor(e){this.image={name:"/",type:i.dir,body:[{name:"usr",type:i.dir,body:[{name:"bin",type:i.dir,body:[]},{name:"config",type:i.text,body:""}]}]},this.path=[this.image],this.exePath=[this.parsePath("/usr/bin")?.at(-1)]}setImage(e){this.image=e,this.path=[this.image],this.exePath=[this.parsePath("/usr/bin")?.at(-1)]}execute(e){return Function(e.body)()}getFile(e,t=this.getWorkingDirectory()){for(let i of t.body)if(i.name==e)return i}getExecutableFile(){let e=[];for(let t of this.exePath)for(let s of t.body)s.type==i.exe&&e.push(s);return e}parsePath(e){let t,i="/"==e?["/"]:e.split("/"),s=this.path.slice();if(0==e.length)return s;"/"==e[0]&&(i[0]="/");for(let e=0;e<i.length;e++){let n=i[e];if("."!=n)if(".."==n)this.cdParentDir(s);else if(n==this.image.name)this.cdRoot(s);else{if(e!=i.length-1&&0==this.cdChildDir(n,s))return;if(e==i.length-1){if(t=this.getFile(i[e],s.at(-1)),null==t)return;s.push(t)}}}return s}parsePathToString(e){let t="";for(let i in e)"/"==e[i].name||parseInt(i)==e.length-1?t+=e[i].name:t+=e[i].name+"/";return t}completePath(e){let t,i,s=e.lastIndexOf("/");-1==s?(t="",i=e.slice()):(t=e.slice(0,s),""==t&&(t="/"),i=e.slice(s+1));let n=this.parsePath(t);if(null!=n)for(let e of n.at(-1).body)if(e.name.length>i.length&&e.name.slice(0,i.length)==i){return e.name.slice(i.length)}return""}setWorkingDirectory(e,t){let s=this.parsePath(e);return!(!s||s.at(-1)?.type!=i.dir)&&(t?t=s:this.path=s,!0)}getWorkingDirectory(e=this.path){return e.at(-1)}getWorkingDirectoryPath(e=this.path){return e.slice()}append(e){return""!=e.name&&"/"!=e.name&&(this.getWorkingDirectory().body.push(e),!0)}delete(e,t=!1){let s=this.getWorkingDirectory().body;for(let n in s)if(s[n].name==e){if(0==t)return s.splice(parseInt(n),1),!0;if(1==t&&s[n].type==i.dir)return s.splice(parseInt(n),1),!0}return!1}cdRoot(e=this.path){e.splice(0),e.push(this.image)}cdParentDir(e=this.path){e.length>1&&e.pop()}cdChildDir(e,t=this.path){let s=t.at(-1).body;for(let n of s)if(n.type==i.dir&&n.name==e)return t.push(n),!0;return!1}}class n{terminal;fs;cmdset;hotkeySet;errorMsgSet;config;constructor(e){this.terminal=e,this.fs=new s,this.cmdset={},this.hotkeySet={"+":{},"ctrl+":{},"alt+":{}},this.errorMsgSet={CommandNotFound:e=>`xdsh: ${e}: command not found`,NoSuchFileOrDirectory:e=>`cannot access ${e}: No such file or directory`,NotADirectory:e=>`not a directory: ${e}`,IsADirectory:e=>`${e}: Is a directory`,InvalidOption:e=>`invalid option -- '${e}'`},this.config={user:"root",version:"0.0.0",hostname:"shell",pathNumber:2}}init(e){e&&this.fs.setImage(e),this.initConfig(),this.terminal.cmdline.command.addEventListener("input",(()=>{this.terminal.cmdline.autoComplete.innerHTML=this.getAutoComplete()})),this.registerHotkey("Enter",(e=>{e.preventDefault();let t=this.terminal.cmdline.getLine(),i=this.terminal.cmdline.getCommad(),s=this.parseCmd(i);this.terminal.history.appendElement(t),this.exec(s),this.terminal.cmdline.clear(),this.terminal.cmdline.setTime()})),this.registerHotkey("Tab",(e=>{e.preventDefault(),this.terminal.cmdline.autoComplete.innerHTML&&(this.terminal.cmdline.setCommand(this.terminal.cmdline.getCommad()+this.getAutoComplete()),this.terminal.cmdline.autoComplete.innerHTML="",this.terminal.cmdline.focus())})),this.registerHotkey("l",(e=>{e.preventDefault(),this.terminal.history.clear(),this.terminal.cmdline.clear()}),!0),this.registerHotkey("u",(e=>{e.preventDefault(),this.terminal.cmdline.clear()}),!0),document.addEventListener("keydown",(e=>{let t=e.key;e.ctrlKey?this.hotkeySet["ctrl+"][t]&&this.hotkeySet["ctrl+"][t](e):e.altKey?this.hotkeySet["alt+"][t]&&this.hotkeySet["alt+"][t](e):this.hotkeySet["+"][t]&&this.hotkeySet["+"][t](e)}),!1),this.setPrompt()}initConfig(){try{this.config=JSON.parse(this.fs.parsePath("/usr/config").at(-1).body)}catch(e){console.log("/usr/config :"+e)}this.setPrompt()}setPrompt(){let e=this.fs.getWorkingDirectoryPath().slice(),t=this.config.pathNumber>e.length?0:e.length-this.config.pathNumber;this.terminal.cmdline.setPrompt(`${this.config.user} <span style="color:#2d9bf2">\n        ${this.fs.parsePathToString(e.slice(t))}\n      </span><span style="color:#ff6ac1">\n         >&nbsp\n      </span>`)}getAutoComplete(){let e=this.parseCmd(this.terminal.cmdline.getCommad());if(1==e.length){for(let t in this.cmdset)if(t.length>e[0].length&&t.slice(0,e[0].length)==e[0]){return t.slice(e[0].length)}}else if(e.length>1)return this.fs.completePath(e.at(-1));return""}parseCmd(e){return e.trimStart().split(/\s+/)}exec(e){return 0==e.length||(1==e.length&&""==e[0]||(this.cmdset[e[0]]?0!=this.cmdset[e[0]].exec(e)||(this.setErrorMsg(this.errorMsgSet.InvalidOption(e[0])),!1):(this.setErrorMsg(this.errorMsgSet.CommandNotFound(e[0])),!1)))}setErrorMsg(e){this.terminal.history.appendPassage(e)}registerHotkey(e,t,i=!1,s=!1){i?this.hotkeySet["ctrl+"][e]=t:s?this.hotkeySet["alt+"][e]=t:this.hotkeySet["+"][e]=t}}class r{history;constructor(e){this.history=e}appendElement(e){this.history.append(e)}appendSentence(e){this.history.append(e),this.history.append(document.createElement("br"))}appendPassage(e){let t=e.split("\n");for(let e of t)this.appendSentence(e)}clear(){this.history.innerHTML=""}}class a{cli;prompt;command;autoComplete;time;constructor(e){this.cli=e,this.prompt=e.getElementsByClassName("xdsh-cli__prompt")[0],this.command=e.getElementsByClassName("xdsh-cli__command")[0],this.autoComplete=e.getElementsByClassName("xdsh-cli__auto-complete")[0],this.time=e.getElementsByClassName("xdsh-cli__time")[0],this.command.addEventListener("keypress",(e=>{"Enter"===e.key&&e.preventDefault()})),this.autoComplete.onclick=()=>{this.focus()},this.setTime()}focus(){let e=window.getSelection();this.command.focus(),e&&(e.selectAllChildren(this.command),e.collapseToEnd())}getLine(){return this.cli.cloneNode(!0)}getPrompt(){return this.prompt.innerText}setPrompt(e){this.prompt.innerHTML=e}getCommad(){return this.command.innerText}setCommand(e){this.command.innerHTML=e}setTime(){let e=new Date;this.time.innerHTML=new Date(e.getTime()-6e4*e.getTimezoneOffset()).toISOString().slice(11,19).replace(/-/g,"/")}clear(){this.command.innerHTML="",this.autoComplete.innerHTML=""}}var l={name:"/",type:0,body:[{name:"usr",type:0,body:[{name:"bin",type:0,body:[]},{name:"config",type:1,body:'{"user": "insorker",version:"v1.0.0",hostname:"xdsh","pathNumber":2}'}]},{name:"insorker",type:0,body:[]}]};let h=new class{history;cmdline;constructor(e){this.history=new r(e.getElementsByClassName("xdsh-history")[0]),this.cmdline=new a(e.getElementsByClassName("xdsh-cli")[0])}}(document.getElementsByClassName("xdsh-terminal")[0]),o=new class extends n{constructor(e){super(e)}init(e){super.init(e),this.initCommand()}initCommand(){this.cmdset.help={name:"help",manual:"",exec:e=>1==e.length&&this.cmdset[e[0]]?(this.terminal.history.appendPassage(this.cmdset[e[0]].manual),!0):!!this.cmdset[e[1]]&&(this.terminal.history.appendPassage(this.cmdset[e[1]].manual),!0)},this.cmdset.ls={name:"ls",manual:"",exec:e=>{let t=this.fs.getWorkingDirectory(),s=(e,t,i)=>{let s=document.createElement(e);return s.innerText=t,s.className=i,s},n=document.createElement("div");if(n.className="xdsh-cmd__ls",e.length>1){let i=this.fs.parsePath(e[1]);if(!i)return!1;t=i.at(-1)}if(t.type==i.dir)for(let e of t.body){let t;switch(e.type){case i.dir:t=s("div",e.name,"xdsh-cmd__ls-dir");break;case i.text:t=s("div",e.name,"xdsh-cmd__ls-text");break;case i.link:t=s("a",e.name,"xdsh-cmd__ls-link"),t.setAttribute("href",e.body),t.setAttribute("target","_blank");break;case i.exe:t=s("div",e.name,"xdsh-cmd__ls-exe");break;default:return!1}n.appendChild(t)}else n.innerHTML=t.name;return this.terminal.history.appendElement(n),!0}},this.cmdset.cd={name:"cd",manual:"",exec:e=>1==e.length?(this.fs.cdRoot(this.fs.path),this.setPrompt(),!0):!!this.fs.setWorkingDirectory(e[1])&&(this.setPrompt(),!0)},this.cmdset.rm={name:"rm",manual:"",exec:e=>(this.fs.delete(e[1],"-r"==e[2]),!0)},this.cmdset.pwd={name:"pwd",manual:"",exec:e=>(this.terminal.history.appendSentence(this.fs.parsePathToString(this.fs.getWorkingDirectoryPath())),!0)},this.cmdset.cat={name:"cat",manual:"",exec:e=>{if(e.length<=1)return!1;let t=this.fs.parsePath(e[1]);if(t){let e=t.at(-1);if(e.type!=i.dir)return this.terminal.history.appendPassage(e.body),!0}return!1}},this.cmdset.mkdir={name:"mkdir",manual:"",exec:e=>!(e.length<=1)&&this.fs.append({name:e[1],type:i.dir,body:[]})},this.cmdset.touch={name:"touch",manual:"",exec:e=>{if(e.length<=1)return!1;let t=i.text;return"text"==e[2]?t=i.text:"link"==e[2]?t=i.link:"exe"==e[2]&&(t=i.exe),this.fs.append({name:e[1],type:t,body:e[3]?e[3]:""})}},this.cmdset.vim={name:"vim",manual:"",exec:e=>{if(e.length<=2)return!1;let t=this.fs.parsePath(e[1]);if(t){let s=t.at(-1);if(s.type!=i.dir)return s.body=e[2],!0}return!1}},this.cmdset.clear={name:"clear",manual:"",exec:e=>(this.terminal.history.clear(),this.terminal.cmdline.clear(),!0)},this.cmdset.import={name:"pwd",manual:"",exec:e=>{const t=document.createElement("input");return t.setAttribute("type","file"),t.setAttribute("accept",".json"),t.addEventListener("change",(e=>{let i=new FileReader;null!=t.files&&(i.readAsText(t.files[0],"utf-8"),i.onload=()=>{try{if(i.result){let e=JSON.parse(i.result.toString());this.fs.setImage(e),this.terminal.history.appendSentence("Load successfully")}}catch(e){this.terminal.history.appendSentence("Load failed"),console.error(e)}})})),t.click(),!0}},this.cmdset.export={name:"export",manual:"",exec:e=>{let t="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(this.fs.image)),i=document.createElement("a");return i.setAttribute("href",t),i.setAttribute("download","image.json"),i.click(),i.remove(),!0}},this.cmdset.lisp={name:"lisp",manual:"Building...",exec:e=>!0},this.cmdset.card={name:"card",manual:"Building...",exec:e=>!0}}}(h);o.init(l);
